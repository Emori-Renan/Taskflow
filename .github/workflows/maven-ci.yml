name: Auth Service CI Build

on:
  push:
    # Trigger on code pushed to the main branch
    branches:
      - main
    # Only run the workflow if files in the auth-service directory change
    paths:
      - 'auth-service/**'
      - 'pom.xml' # If the parent POM changes

jobs:
  build_and_test:
    runs-on: ubuntu-latest # Use a standard Linux runner

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK 23
      uses: actions/setup-java@v4
      with:
        java-version: '23'
        distribution: 'temurin'
        cache: 'maven' # Cache Maven dependencies for faster builds
        
    - name: Set up H2 for Testing (Optional)
      # Since H2 is in-memory, no external service is strictly needed, 
      # but this is where you'd set up Testcontainers if you were using PostgreSQL.
      run: echo "Using in-memory H2 database for @DataJpaTest integration tests."

    - name: Run Maven Build, Tests, and Install
      # This is the exact command that worked locally, ensuring the 'test' profile is active.
      # The -B (batch mode) is recommended for CI.
      run: |
        mvn -B -Dspring.profiles.active=test clean install
      working-directory: ./auth-service # Ensure the command runs inside the module directory

    - name: Upload Auth Service JAR
      # If the build succeeds, upload the deployable artifact
      uses: actions/upload-artifact@v4
      with:
        name: auth-service-jar
        path: auth-service/target/auth-service-*.jar
        if-no-files-found: error