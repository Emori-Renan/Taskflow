services:
  postgres:
    image: postgres:15
    container_name: taskflow-postgres
    environment:
      POSTGRES_USER: taskflow
      POSTGRES_PASSWORD: taskflow
      POSTGRES_DB: authdb
      POSTGRES_HOST_AUTH_METHOD: trust
    ports:
      - "5433:5432" # Host port 5433 mapped to container port 5432
    volumes:
      - pgdata:/var/lib/postgresql/data
    networks:
      - taskflow-net
    # RECOMMENDED FIX: Healthcheck to ensure the DB is ready before the app starts
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U taskflow -d authdb"]
      interval: 5s
      timeout: 5s
      retries: 5

  redis:
    image: redis:7
    container_name: taskflow-redis
    ports:
      - "6379:6379"
    networks:
      - taskflow-net

  auth-service:
    build:
      context: ./auth-service
      dockerfile: Dockerfile
    container_name: auth-service
    # NOTE: Application port should match your container port setup (8081 in this case)
    ports:
      - "8081:8081" 
    environment:
      - JWT_SECRET=yourSuperSecretKey
      - spring.r2dbc.url=r2dbc:postgresql://postgres:5432/authdb
      - spring.r2dbc.username=taskflow
      - spring.r2dbc.password=taskflow
      
      # Recommended replacement for old 'SPRING_JPA_HIBERNATE_DDL_AUTO' for schema initialization
      - spring.sql.init.mode=always 

    # Use the healthcheck from the postgres service to guarantee DB readiness
    depends_on:
      postgres:
        condition: service_healthy 
      
    networks:
      - taskflow-net

  gateway-service:
    build:
      context: ./gateway-service/
      dockerfile: Dockerfile
    container_name: gateway-service
    ports:
      - "8080:8080"
    environment:
      - JWT_SECRET=yourSuperSecretKey
    depends_on:
      - auth-service
      - redis
    networks:
      - taskflow-net

volumes:
  pgdata:

networks:
  taskflow-net: